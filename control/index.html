<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1024">
    <title>لوحة تحكم موقع رسلان</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Shared variables */
        :root {
            --primary: #0a3d62;
            --secondary: #1a73e8;
            --white: #ffffff;
            --light-gray: #f8fbfd;
            --dark-gray: #4a5568;
        }

        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; }
        .sidebar-link.active { background-color: #2563eb; color: white; }
        .form-input {
            width: 100%;
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            outline: none;
            background-color: white; /* Ensure input background is white */
        }
        .form-input:focus {
            ring: 2px;
            ring-color: #2563eb;
            border-color: #2563eb;
        }
        .form-input[readonly] {
            background-color: #e2e8f0; /* Lighter background for read-only */
            cursor: not-allowed;
        }

        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
            background: white; /* Modal content background */
            border-radius: 0.75rem; /* Consistent border radius */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .ltr-input { direction: ltr; text-align: left; }

        /* Custom styles for layout and responsiveness */
        .sidebar-header {
            display: flex;
            flex-direction: column; /* Changed to column for stacked logo and info */
            align-items: center;
            gap: 0.5rem; /* Smaller gap */
            padding: 1.5rem;
            border-bottom: 1px solid #334155;
            background-color: #1e293b;
        }
        .sidebar-header img {
            width: 48px;
            height: 48px;
            object-fit: contain;
        }
        .sidebar-header h1 {
            font-size: 1.75rem;
            color: #f8fafc;
        }

        /* Adjusting main content area for mobile */
        @media (max-width: 767px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                width: 250px;
                transition: left 0.3s ease-in-out;
                z-index: 50;
                background-color: #1e293b; /* Solid background for mobile sidebar */
            }
            .sidebar.open { left: 0; }
            .mr-64 { margin-right: 0; }
            .main-content { padding-top: 5rem; }
            .topbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: fixed;
                top: 0;
                right: 0;
                left: 0;
                height: 4rem;
                background-color: #1e293b;
                color: white;
                padding: 0 1rem;
                z-index: 45;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .topbar .logo-sm { height: 32px; width: auto; }
            .topbar .menu-toggle {
                background: none;
                border: none;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
            }
            .auth-overlay { padding: 1rem; }
        }
        /* Image Preview Styles */
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .image-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 0.25rem;
            border: 1px solid #d1d5db;
            background-color: #e2e8f0;
        }

        /* Notification Toast Styles */
        #notification-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out, transform 0.3s ease-in-out;
            z-index: 9999;
            white-space: nowrap;
            text-align: center;
        }
        #notification-toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-10px);
        }

        /* Samah Reda developer info */
        .developer-info {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 0.5rem; /* Reduced margin */
            font-size: 0.8rem; /* Smaller font size */
            color: #ccc; /* Lighter color for text */
            gap: 0.5rem; /* Space between text and icon */
            text-align: center;
        }
        .developer-info a {
            color: #4ade80; /* WhatsApp green */
            transition: color 0.2s;
        }
        .developer-info a:hover {
            color: #22c55e;
        }

        /* Warning Modal Styles */
        #warningModal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000; /* Higher than other modals/toasts */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #warningModal.show {
            opacity: 1;
            visibility: visible;
        }
        #warningModalContent {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: fit-content; /* Adjust width to content */
            max-width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #warningModalImg {
            max-width: 100%;
            height: auto;
            display: block;
            margin-bottom: 15px;
        }
        #warningModalCloseBtn {
            margin-top: 10px;
            background-color: #ef4444; /* Red color for close button */
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        #warningModalCloseBtn:hover {
            background-color: #dc2626;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="auth-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-slate-800">Admin Raslan</h2>
            <input type="password" id="password-input" class="form-input mb-4" placeholder="أدخل كلمة المرور">
            <button id="login-button" class="btn btn-primary w-full">Login</button>
        </div>
    </div>

    <div id="app-wrapper" class="hidden min-h-screen relative">
        <header id="topbar" class="topbar hidden">
            <img src="https://i.postimg.cc/VNh9nvCV/Untitled-7-01.png" alt="Admin Raslan Logo" class="logo-sm">
            <h1 class="text-xl font-bold text-white">Admin </h1>
            <button id="menu-toggle" class="menu-toggle"><i class="fas fa-bars"></i></button>
        </header>

        <aside id="sidebar" class="fixed top-0 right-0 h-screen w-64 bg-slate-800 text-slate-200 shadow-lg z-40 sidebar">
            <div class="sidebar-header">
                <img src="https://i.postimg.cc/VNh9nvCV/Untitled-7-01.png" alt="Admin Raslan Logo">
                <h1 class="text-white">Admin </h1>
            </div>
            <nav class="mt-6">
                <a href="#" class="sidebar-link flex items-center gap-3 py-3 px-6 hover:bg-slate-700 transition" data-section="about"><i class="fas fa-info-circle w-5"></i><span>من نحن</span></a>
                <a href="#" class="sidebar-link flex items-center gap-3 py-3 px-6 hover:bg-slate-700 transition" data-section="services"><i class="fas fa-concierge-bell w-5"></i><span>الخدمات</span></a>
                <a href="#" class="sidebar-link flex items-center gap-3 py-3 px-6 hover:bg-slate-700 transition" data-section="projects"><i class="fas fa-project-diagram w-5"></i><span>المشاريع</span></a>
                <a href="#" class="sidebar-link flex items-center gap-3 py-3 px-6 hover:bg-slate-700 transition" data-section="team"><i class="fas fa-users w-5"></i><span>فريق العمل</span></a>
                <a href="#" class="sidebar-link flex items-center gap-3 py-3 px-6 hover:bg-slate-700 transition" data-section="workHeroes"><i class="fas fa-hard-hat w-5"></i><span>أبطال أعمالنا</span></a>
                <a href="#" class="sidebar-link flex items-center gap-3 py-3 px-6 hover:bg-slate-700 transition" data-section="clients"><i class="fas fa-handshake w-5"></i><span>العملاء</span></a>
                <a href="#" class="sidebar-link flex items-center gap-3 py-3 px-6 hover:bg-slate-700 transition" data-section="contact"><i class="fas fa-envelope w-5"></i><span>تواصل معنا</span></a>
                <a href="#" class="sidebar-link flex items-center gap-3 py-3 px-6 hover:bg-slate-700 transition" data-section="footer"><i class="fas fa-copyright w-5"></i><span>التذييل</span></a>
            </nav>
            <div class="flex flex-col items-center mt-6">
                <button id="logout-button" class="btn bg-red-600 text-white hover:bg-red-700 py-3 px-6 mb-4"><i class="fas fa-sign-out-alt ml-2"></i> تسجيل الخروج</button>
                <div class="developer-info">
                    <span>Powered By: Sameh Reda</span>
                    <a href="https://api.whatsapp.com/send/?phone=201023160657&text&type=phone_number&app_absent=0" target="_blank">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                </div>
            </div>
        </aside>

        <main class="mr-64 p-8 main-content">
            <div id="loader" class="flex items-center justify-center h-64"><i class="fas fa-spinner fa-spin fa-3x text-blue-600"></i></div>

            <section id="about-section" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6 text-slate-800">تعديل قسم "من نحن"</h2>
                <form id="about-form" class="bg-white p-8 rounded-lg shadow-md space-y-8">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <label class="block font-semibold text-slate-600 mb-2">الفقرة الرئيسية (عربي)</label>
                                <textarea id="aboutP1Ar" class="form-input h-28"></textarea>
                            </div>
                            <div>
                                <label class="block font-semibold text-slate-600 mb-2">الفقرة الرئيسية (إنجليزي)</label>
                                <textarea id="aboutP1En" class="form-input h-28"></textarea>
                            </div>
                            <div>
                                <label class="block font-semibold text-slate-600 mb-2">نص الرؤية (عربي)</label>
                                <textarea id="visionP1Ar" class="form-input h-28"></textarea>
                            </div>
                            <div>
                                <label class="block font-semibold text-slate-600 mb-2">نص الرؤية (إنجليزي)</label>
                                <textarea id="visionP1En" class="form-input h-28"></textarea>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <label class="block font-semibold text-slate-600 mb-2">وصف السرعة (عربي)</label>
                                <textarea id="missionSpeedDescAr" class="form-input h-28"></textarea>
                            </div>
                            <div>
                                <label class="block font-semibold text-slate-600 mb-2">وصف السعر (عربي)</label>
                                <textarea id="missionPriceDescAr" class="form-input h-28"></textarea>
                            </div>
                            <div>
                                <label class="block font-semibold text-slate-600 mb-2">رابط الصورة الأولى</label>
                                <input type="url" id="aboutImg1Url" class="form-input ltr-input">
                            </div>
                            <div>
                                <label class="block font-semibold text-slate-600 mb-2">رابط الصورة الثانية</label>
                                <input type="url" id="aboutImg2Url" class="form-input ltr-input">
                            </div>
                        </div>
                    </div>
                    <div class="pt-6 border-t">
                        <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                    </div>
                </form>
            </section>

            <section id="dynamic-list-section" class="content-section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="dynamic-section-title" class="text-3xl font-bold text-slate-800"></h2>
                    <button id="add-new-item-btn" class="btn btn-primary"><i class="fas fa-plus"></i> إضافة عنصر جديد</button>
                </div>
                <div id="items-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    </div>
            </section>

            <section id="contact-section" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6 text-slate-800">تعديل قسم "تواصل معنا"</h2>
                <form id="contact-form" class="bg-white p-8 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block font-semibold text-slate-600 mb-2">العنوان (عربي)</label>
                        <input type="text" id="addressAr" class="form-input">
                    </div>
                    <div>
                        <label class="block font-semibold text-slate-600 mb-2">العنوان (إنجليزي)</label>
                        <input type="text" id="addressEn" class="form-input">
                    </div>
                    <div>
                        <label class="block font-semibold text-slate-600 mb-2">البريد الإلكتروني</label>
                        <input type="email" id="email" class="form-input ltr-input">
                    </div>
                    <div>
                        <label class="block font-semibold text-slate-600 mb-2">رقم الهاتف</label>
                        <input type="tel" id="phone" class="form-input ltr-input">
                    </div>
                    <div>
                        <label class="block font-semibold text-slate-600 mb-2">رقم واتساب العائم (مع رمز الدولة، مثال: 201xxxxxxxx)</label>
                        <input type="text" id="whatsappFloatPhone" class="form-input ltr-input">
                    </div>
                    <div>
                        <label class="block font-semibold text-slate-600 mb-2">رابط Facebook</label>
                        <input type="url" id="facebookLink" class="form-input ltr-input">
                    </div>
                    <div>
                        <label class="block font-semibold text-slate-600 mb-2">رابط Instagram</label>
                        <input type="url" id="instagramLink" class="form-input ltr-input">
                    </div>
                    <div>
                        <label class="block font-semibold text-slate-600 mb-2">رابط iframe الخريطة (Google Maps Embed)</label>
                        <textarea id="mapIframeSrc" class="form-input h-28 ltr-input"></textarea>
                    </div>
                    <div class="md:col-span-2 pt-6 border-t">
                        <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                    </div>
                </form>
            </section>
            <section id="footer-section" class="content-section hidden">
                <h2 class="text-3xl font-bold mb-6 text-slate-800">تعديل التذييل</h2>
                <form id="footer-form" class="bg-white p-8 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block font-semibold text-slate-600 mb-2">نص حقوق النشر (عربي)</label>
                        <input type="text" id="copyrightAr" class="form-input">
                    </div>
                    <div>
                        <label class="block font-semibold text-slate-600 mb-2">نص حقوق النشر (إنجليزي)</label>
                        <input type="text" id="copyrightEn" class="form-input">
                    </div>
                    <div>
                        <label class="block font-semibold text-slate-600 mb-2">نص "تم التنفيذ بواسطة" (عربي)</label>
                        <input type="text" id="poweredByAr" class="form-input" readonly
                            onclick="showWarningModal()" onkeydown="showWarningModal()" onpaste="showWarningModal()">
                    </div>
                    <div>
                        <label class="block font-semibold text-slate-600 mb-2">نص "Powered By" (إنجليزي)</label>
                        <input type="text" id="poweredByEn" class="form-input" readonly
                            onclick="showWarningModal()" onkeydown="showWarningModal()" onpaste="showWarningModal()">
                    </div>
                    <div>
                        <label class="block font-semibold text-slate-600 mb-2">رابط واتساب للمطور</label>
                        <input type="url" id="developerWhatsapp" class="form-input ltr-input" readonly
                            onclick="showWarningModal()" onkeydown="showWarningModal()" onpaste="showWarningModal()">
                    </div>
                    <div class="md:col-span-2 pt-6 border-t">
                        <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                    </div>
                </form>
            </section>
        </main>
    </div>

    <div id="item-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl transform scale-95 max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-2xl font-bold mb-6 text-slate-800"></h3>
            <form id="modal-form" class="space-y-4">
                </form>
            <div class="flex justify-end gap-4 mt-8 pt-6 border-t">
                <button type="button" id="modal-cancel-btn" class="btn bg-slate-200 text-slate-700 hover:bg-slate-300">إلغاء</button>
                <button type="submit" form="modal-form" id="modal-save-btn" class="btn btn-primary">حفظ</button>
            </div>
        </div>
    </div>

    <div id="notification-toast"></div>

    <div id="warningModal" class="hidden">
        <div id="warningModalContent">
            <img src="https://mediaaws.almasryalyoum.com/caricature/large/18256_caricature.png" alt="Warning" id="warningModalImg">
            <button id="warningModalCloseBtn">إغلاق</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getDatabase, ref, get, set, update, remove, push } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyA12fSyvBCdVF62xVwGaEuJXlJOpGEMoKI",
            authDomain: "raslan2025-47c6c.firebaseapp.com",
            databaseURL: "https://raslan2025-47c6c-default-rtdb.firebaseio.com",
            projectId: "raslan2025-47c6c",
            storageBucket: "raslan2025-47c6c.appspot.com",
            messagingSenderId: "320802083048",
            appId: "1:320802083048:web:3c2d279b270443bfbc395d",
            measurementId: "G-W1GWY4X7D6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentSection = 'about';
        let sectionsData = {};
        let sortableInstance = null;

        // --- Notification Function ---
        function showNotification(message, type = 'info') {
            const toast = document.getElementById('notification-toast');
            toast.textContent = message;
            toast.className = ''; // Reset classes

            // Apply styling based on type (you can expand this with more colors)
            if (type === 'success') {
                toast.style.backgroundColor = 'rgba(40, 167, 69, 0.8)'; // Green
            } else if (type === 'error') {
                toast.style.backgroundColor = 'rgba(220, 53, 69, 0.8)'; // Red
            } else {
                toast.style.backgroundColor = 'rgba(0, 0, 0, 0.7)'; // Default dark
            }

            // Determine display duration based on message length
            const displayDuration = message.length > 50 ? 5000 : 3000; // 5 seconds for long messages, 3 for short

            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, displayDuration);
        }

        // --- Warning Modal Function ---
        let warningModalTimeout;
        function showWarningModal() {
            const modal = document.getElementById('warningModal');
            const closeBtn = document.getElementById('warningModalCloseBtn');

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('show');
            }, 10); // Small delay for transition

            // Auto-hide after 2 seconds
            warningModalTimeout = setTimeout(() => {
                hideWarningModal();
            }, 2000);

            // Close on button click
            closeBtn.onclick = () => {
                clearTimeout(warningModalTimeout); // Clear auto-hide timeout
                hideWarningModal();
            };

            // Close on overlay click
            modal.onclick = (event) => {
                if (event.target === modal) {
                    clearTimeout(warningModalTimeout); // Clear auto-hide timeout
                    hideWarningModal();
                }
            };
        }

        function hideWarningModal() {
            const modal = document.getElementById('warningModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); // Wait for transition to complete before hiding
        }


        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const loginButton = document.getElementById('login-button');
            const passwordInput = document.getElementById('password-input');
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const logoutButton = document.getElementById('logout-button');

            const handleLogin = () => {
                if (passwordInput.value === '12345') { // Change this password
                    document.getElementById('auth-overlay').classList.add('hidden');
                    document.getElementById('app-wrapper').classList.remove('hidden');
                    if (window.innerWidth < 768) {
                        document.getElementById('topbar').classList.remove('hidden');
                    }
                    initializeAppLogic();
                } else {
                    showNotification('كلمة المرور غير صحيحة!', 'error');
                }
            };

            const handleLogout = () => {
                if (confirm('هل أنت متأكد أنك تريد تسجيل الخروج؟')) {
                    location.reload(); // Simply reload to go back to login screen
                }
            };

            loginButton.addEventListener('click', handleLogin);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            logoutButton.addEventListener('click', handleLogout);

            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('open');
                });
            }

            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 768) {
                        sidebar.classList.remove('open');
                    }
                });
            });

            window.addEventListener('resize', () => {
                if (window.innerWidth >= 768) {
                    sidebar.classList.remove('open');
                    sidebar.classList.remove('fixed', 'top-0', 'left-[-100%]');
                    sidebar.classList.add('fixed', 'top-0', 'right-0', 'w-64');
                    document.getElementById('topbar').classList.add('hidden');
                    document.querySelector('main').classList.add('mr-64');
                    document.querySelector('main').classList.remove('padding-top');
                } else {
                    sidebar.classList.add('fixed', 'top-0', 'left-[-100%]', 'w-64');
                    sidebar.classList.remove('right-0');
                    document.getElementById('topbar').classList.remove('hidden');
                    document.querySelector('main').classList.remove('mr-64');
                    document.querySelector('main').classList.add('padding-top');
                }
            });

            if (window.innerWidth < 768 && !document.getElementById('app-wrapper').classList.contains('hidden')) {
                document.getElementById('topbar').classList.remove('hidden');
                document.querySelector('main').classList.remove('mr-64');
            } else if (window.innerWidth >= 768) {
                   document.getElementById('sidebar').classList.remove('left-[-100%]');
                   document.getElementById('sidebar').classList.add('right-0');
            }
        });

        async function initializeAppLogic() {
            document.getElementById('loader').classList.remove('hidden');
            setupEventListeners();
            await loadAllData();
            document.getElementById('loader').classList.add('hidden');
            navigateToSection('about');
        }

        async function loadAllData() {
            const sectionsToLoad = ['about', 'services', 'projects', 'workHeroes', 'team', 'clients', 'contact', 'footer'];
            try {
                for (const section of sectionsToLoad) {
                    const snapshot = await get(ref(db, section));
                    sectionsData[section] = snapshot.exists() ? snapshot.val() : {};
                }
            } catch (error) {
                showNotification("فشل تحميل البيانات الأولية. تحقق من قواعد الأمان والاتصال.", 'error');
            }
        }

        function navigateToSection(sectionId) {
            currentSection = sectionId;
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.add('hidden'));
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.toggle('active', link.dataset.section === sectionId);
            });
            const sectionMap = {
                'about': 'about-section', 'contact': 'contact-section', 'footer': 'footer-section'
            };

            if (sectionMap[sectionId]) {
                if (sortableInstance) {
                    sortableInstance.destroy();
                    sortableInstance = null;
                }
                populateStaticForm(sectionId);
                document.getElementById(sectionMap[sectionId]).classList.remove('hidden');
            } else {
                renderDynamicList(sectionId);
                document.getElementById('dynamic-list-section').classList.remove('hidden');
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateToSection(e.currentTarget.dataset.section);
                });
            });
            document.getElementById('about-form').addEventListener('submit', (e) => saveStaticForm(e, 'about'));
            document.getElementById('contact-form').addEventListener('submit', (e) => saveStaticForm(e, 'contact'));
            document.getElementById('footer-form').addEventListener('submit', (e) => saveStaticForm(e, 'footer'));
            document.getElementById('add-new-item-btn').addEventListener('click', openModalForNew);
            document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
            document.getElementById('modal-form').addEventListener('submit', saveModalForm);
        }

        // --- Static Form Handlers (About, Contact, Footer) ---
        const staticFormsConfig = {
            about: ['aboutP1Ar', 'aboutP1En', 'visionP1Ar', 'visionP1En', 'missionSpeedDescAr', 'missionPriceDescAr', 'aboutImg1Url', 'aboutImg2Url'],
            contact: ['addressAr', 'addressEn', 'email', 'phone', 'whatsappFloatPhone', 'mapIframeSrc', 'facebookLink', 'instagramLink'],
            footer: ['copyrightAr', 'copyrightEn', 'poweredByAr', 'poweredByEn', 'developerWhatsapp']
        };

        function populateStaticForm(sectionId) {
            const data = sectionsData[sectionId] || {};
            const formContainer = document.getElementById(`${sectionId}-form`);
            formContainer.innerHTML = '';
            staticFormsConfig[sectionId].forEach(key => {
                const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                const value = data[key] || '';
                const isTextarea = key.toLowerCase().includes('desc') || key.toLowerCase().includes('src');
                const isUrl = key.toLowerCase().includes('url') || key.toLowerCase().includes('link') || key.toLowerCase().includes('src');
                const isReadOnly = (sectionId === 'footer' && (key === 'poweredByAr' || key === 'poweredByEn' || key === 'developerWhatsapp'));

                const readOnlyEvents = isReadOnly ? `onclick="showWarningModal()" onkeydown="showWarningModal()" onpaste="showWarningModal()"` : '';

                const fieldHtml = `
                    <div>
                        <label class="block font-semibold text-slate-600 mb-2">${label}</label>
                        ${isTextarea ?
                            `<textarea id="${key}" class="form-input h-28" ${isReadOnly ? 'readonly' : ''} ${readOnlyEvents}>${value}</textarea>` :
                            `<input type="${isUrl ? 'url' : 'text'}" id="${key}" value="${value}" class="form-input ${isUrl ? 'ltr-input' : ''}" ${isReadOnly ? 'readonly' : ''} ${readOnlyEvents}>`
                        }
                    </div>`;
                formContainer.insertAdjacentHTML('beforeend', fieldHtml);
            });
            formContainer.insertAdjacentHTML('beforeend', `<div class="md:col-span-2 pt-6 border-t"><button type="submit" class="btn btn-primary">حفظ التغييرات</button></div>`);
        }

        async function saveStaticForm(e, sectionId) {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> جارٍ الحفظ...`;

            const dataToSave = {};
            staticFormsConfig[sectionId].forEach(key => {
                if (!(sectionId === 'footer' && (key === 'poweredByAr' || key === 'poweredByEn' || key === 'developerWhatsapp'))) {
                    dataToSave[key] = document.getElementById(key).value;
                } else {
                    dataToSave[key] = sectionsData[sectionId][key];
                }
            });

            try {
                await set(ref(db, sectionId), {...sectionsData[sectionId], ...dataToSave});
                sectionsData[sectionId] = {...sectionsData[sectionId], ...dataToSave};
                showNotification('تم الحفظ بنجاح!', 'success');
            }
            catch (error) {
                showNotification(`خطأ في الحفظ: ${error.message}. تأكد من قواعد الأمان.`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = 'حفظ التغييرات';
            }
        }

        // --- Dynamic List & Modal Handlers ---
        const dynamicSectionsConfig = {
            services:    { // UPDATED
                title: 'الخدمات',
                fields: {
                    titleAr: 'العنوان (عربي)',
                    titleEn: 'العنوان (إنجليزي)',
                    descAr: 'الوصف (عربي)',
                    descEn: 'الوصف (إنجليزي)',
                    imageUrl: 'رابط الصورة الرئيسية للبطاقة', // Changed from mainImageUrl
                    galleryImages: 'روابط صور المعرض (افصل بينها بفاصلة أو سطر جديد)'
                }
            },
            projects:    {
                title: 'المشاريع',
                fields: {
                    titleAr: 'العنوان (عربي)',
                    titleEn: 'العنوان (إنجليزي)',
                    descAr: 'الوصف (عربي)',
                    descEn: 'الوصف (إنجليزي)',
                    imageUrl: 'رابط الصورة الرئيسية للبطاقة', // Changed from mainImageUrl
                    galleryImages: 'روابط صور المعرض (افصل بينها بفاصلة أو سطر جديد)'
                }
            },
            team:        { title: 'فريق العمل', fields: { nameAr: 'الاسم (عربي)', nameEn: 'الاسم (إنجليزي)', positionAr: 'المنصب (عربي)', positionEn: 'المنصب (إنجليزي)', imageUrl: 'رابط الصورة' } },
            workHeroes: { title: 'أبطال أعمالنا', fields: { imageUrl: 'رابط الصورة' } },
            clients:    { title: 'العملاء', fields: { nameAr: 'اسم العميل (عربي)', nameEn: 'اسم العميل (إنجليزي)', imageUrl: 'رابط الشعار' } }, // Changed logoUrl to imageUrl
        };

        function renderDynamicList(sectionId) {
            const config = dynamicSectionsConfig[sectionId];
            document.getElementById('dynamic-section-title').textContent = config.title;
            const container = document.getElementById('items-container');
            container.innerHTML = '';

            if (sortableInstance) {
                sortableInstance.destroy();
                sortableInstance = null;
            }

            const items = sectionsData[sectionId] || {};
            let itemsArray = Object.entries(items).map(([id, item]) => ({ id, ...item }));

            if (itemsArray.length > 0) {
                itemsArray.forEach(({ id, ...item }) => {
                    const title = item.titleAr || item.nameAr || 'عنصر بدون عنوان';
                    // Use 'imageUrl' consistently for the main image of the card
                    let image = item.imageUrl || 'https://placehold.co/600x400/e2e8f0/cccccc?text=No+Image';

                    const card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-lg shadow-md flex flex-col justify-between";
                    card.innerHTML = `
                        <div>
                            <img src="${image}" class="h-40 w-full object-cover rounded-md mb-4 bg-slate-100" onerror="this.src='https://placehold.co/600x400/e2e8f0/cccccc?text=Error'; this.onerror=null;">
                            <h4 class="font-bold text-lg mb-4 truncate">${title}</h4>
                            ${(sectionId === 'projects' || sectionId === 'services') && item.galleryImages && item.galleryImages.length > 0 ? `<p class="text-sm text-slate-500">صور إضافية: ${item.galleryImages.length}</p>` : ''}
                        </div>
                        <div class="flex gap-2 justify-end mt-4">
                            <button class="btn text-sm bg-slate-600 text-white hover:bg-slate-700 edit-btn">تعديل</button>
                            <button class="btn text-sm btn-danger delete-btn">حذف</button>
                        </div>
                    `;
                    card.querySelector('.edit-btn').addEventListener('click', () => openModalForEdit(sectionId, id));
                    card.querySelector('.delete-btn').addEventListener('click', () => deleteItem(sectionId, id));

                    container.appendChild(card);
                });
            } else {
                container.innerHTML = `<p class="text-slate-500 col-span-full text-center py-8">لا توجد عناصر في هذا القسم بعد.</p>`;
            }
        }

        function openModalForNew() {
            const config = dynamicSectionsConfig[currentSection];
            document.getElementById('modal-title').textContent = `إضافة ${config.title} جديد`;
            generateModalFormFields(currentSection);
            showModal();
        }

        function openModalForEdit(sectionId, itemId) {
            const item = sectionsData[sectionId][itemId];
            const config = dynamicSectionsConfig[sectionId];
            document.getElementById('modal-title').textContent = `تعديل ${config.title}`;
            generateModalFormFields(sectionId, item, itemId);
            showModal();
        }

        function generateModalFormFields(sectionId, itemData = {}, itemId = '') {
            const form = document.getElementById('modal-form');
            form.innerHTML = `<input type="hidden" id="modal-item-id" value="${itemId}">`;
            const fields = dynamicSectionsConfig[sectionId].fields;

            for (const [key, label] of Object.entries(fields)) {
                let value = itemData[key];
                if (value === undefined || value === null) {
                    value = '';
                }

                let type = 'text';
                let isTextarea = false;
                let isLtr = false;
                let uploadButtonHtml = '';
                let isImageUrlField = false;

                // Handle URL fields (imageUrl, logoUrl, mainImageUrl - now unified to imageUrl)
                if (key.includes('Url') || key.includes('logoUrl')) { // Simplified logic
                    type = 'url';
                    isLtr = true;
                    isImageUrlField = true;
                    uploadButtonHtml = `
                        <button type="button" class="btn bg-blue-500 text-white hover:bg-blue-600 text-sm py-2 px-3 self-end"
                                onclick="openPostimageUploader()">
                            <i class="fas fa-upload ml-1"></i> رفع (Postimage)
                        </button>
                    `;
                }
                // Handle galleryImages specifically
                if (key === 'galleryImages') {
                    isTextarea = true;
                    if (Array.isArray(value)) {
                        value = value.join('\n'); // Use newline for gallery images for easier pasting of multiple links
                    }
                    isLtr = true;
                    isImageUrlField = true; // Mark as image URL field for preview
                    uploadButtonHtml = `
                        <button type="button" class="btn bg-blue-500 text-white hover:bg-blue-600 text-sm py-2 px-3 self-end"
                                onclick="openPostimageUploader()">
                            <i class="fas fa-upload ml-1"></i> رفع (Postimage)
                        </button>
                    `;
                }
                if (key.includes('desc')) {
                    isTextarea = true;
                }


                const fieldHtml = `
                    <div class="flex flex-col gap-1">
                        <label class="block font-semibold text-slate-600 mb-1">${label}</label>
                        ${isImageUrlField ? `<div id="preview-${key}" class="image-preview-container"></div>` : ''}
                        <div class="flex items-end gap-2">
                            <div class="flex-grow">
                                ${isTextarea ?
                                    `<textarea id="modal-${key}" class="form-input h-28 ${isLtr ? 'ltr-input' : ''}" data-is-image-url="${isImageUrlField}" data-is-gallery="${key === 'galleryImages'}" oninput="handleUrlInput(this)">${value}</textarea>` :
                                    `<input type="${type}" id="modal-${key}" value="${value}" class="form-input ${isLtr ? 'ltr-input' : ''}" data-is-image-url="${isImageUrlField}" data-is-gallery="${key === 'galleryImages'}" oninput="handleUrlInput(this)">`
                                }
                            </div>
                            ${uploadButtonHtml}
                        </div>
                    </div>`;
                form.insertAdjacentHTML('beforeend', fieldHtml);

                if (isImageUrlField && value) {
                    const inputElement = form.querySelector(`#modal-${key}`);
                    handleUrlInput(inputElement);
                }
            }
        }

        window.openPostimageUploader = () => {
            window.open('https://postimages.org/', '_blank');
            showNotification('الرجاء رفع صورك على Postimage.org ونسخ الروابط. ثم الصقها في الحقل المناسب هنا. لحقول المعرض، يمكن لصق عدة روابط مفصولة بمسافات أو أسطر جديدة وسيتم فصلها تلقائياً.', 'info');
        };

        function handleUrlInput(inputElement) {
            const isGallery = inputElement.dataset.isGallery === 'true';
            const rawText = inputElement.value;
            let urls = [];

            // Split by comma, newline, or space
            const potentialUrls = rawText.split(/[\s,]+/).map(s => s.trim()).filter(s => s);

            potentialUrls.forEach(potentialUrl => {
                try {
                    const url = new URL(potentialUrl);
                    if (url.protocol === 'http:' || url.protocol === 'https:') {
                        urls.push(potentialUrl);
                    }
                } catch (e) {
                    // Not a valid URL
                }
            });

            if (isGallery) {
                // For gallery, preserve newlines in the textarea, but join with comma for internal storage if needed.
                // Here we're just updating the display.
                inputElement.value = urls.join('\n'); // Display with newlines for gallery
            } else {
                inputElement.value = urls[0] || ''; // Only first for single URL
                urls = urls.slice(0, 1); // Only keep the first for preview for single URL
            }

            const previewContainerId = `preview-${inputElement.id.replace('modal-', '')}`;
            const previewContainer = document.getElementById(previewContainerId);
            if (previewContainer) {
                previewContainer.innerHTML = '';
                urls.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = 'image-preview';
                    img.onerror = function() {
                        this.src = 'https://placehold.co/80x80?text=Error';
                    };
                    previewContainer.appendChild(img);
                });
            }
        }

        async function saveModalForm(e) {
            e.preventDefault();
            const button = document.getElementById('modal-save-btn');
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> جارٍ الحفظ...`;

            const itemId = document.getElementById('modal-item-id').value;
            const dataToSave = {};
            const fields = dynamicSectionsConfig[currentSection].fields;

            for (const key of Object.keys(fields)) {
                let inputElement = document.getElementById(`modal-${key}`);
                if (!inputElement) continue;

                let value = inputElement.value;
                if (key === 'galleryImages') {
                    // Split gallery images by new line or comma, trim whitespace, and filter out empty strings
                    value = value.split(/[\n,]+/).map(url => url.trim()).filter(url => url);
                } else if (inputElement.dataset.isImageUrl === 'true') {
                    // For single image URL fields, take only the first valid URL
                    value = value.split(/[\n,]+/).map(url => url.trim()).filter(url => url)[0] || '';
                }
                dataToSave[key] = value;
            }

            const path = itemId ? `${currentSection}/${itemId}` : currentSection;
            let operation;
            if (itemId) {
                operation = update(ref(db, path), dataToSave);
            } else {
                const newItemRef = push(ref(db, currentSection));
                operation = set(newItemRef, dataToSave);
            }

            try {
                await operation;
                showNotification('تم الحفظ بنجاح!', 'success');
                await loadAllData();
                renderDynamicList(currentSection);
                closeModal();
            } catch (error) {
                showNotification(`خطأ في الحفظ: ${error.message}. تأكد من قواعد الأمان.`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = 'حفظ';
            }
        }

        async function deleteItem(sectionId, itemId) {
            if (confirm('هل أنت متأكد من حذف هذا العنصر؟')) {
                try {
                    await remove(ref(db, `${sectionId}/${itemId}`));
                    showNotification('تم الحذف بنجاح.', 'success');
                    await loadAllData();
                    renderDynamicList(sectionId);
                } catch (error) {
                    showNotification(`خطأ في الحذف: ${error.message}`, 'error');
                }
            }
        }

        function showModal() {
            const modal = document.getElementById('item-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('item-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        // Expose to global scope for inline onclick
        window.showWarningModal = showWarningModal;

    </script>
</body>
</html>
